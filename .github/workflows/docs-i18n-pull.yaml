name: 'Pull docs translations from Crowdin'

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    - cron: '0 */2 * * *'
  pull_request:
  workflow_dispatch:
    inputs:
      force_pull:
        description: 'Force pull translations regardless of status'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      force_pull:
        description: 'Force pull translations regardless of status'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  pull_docs_translations:
    name: Pull docs translations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0

      - name: Determine target branch
        id: determine_branch
        run: |
          # For PRs, use the PR branch; for scheduled runs, use i18n branch; for manual dispatch on main, use i18n
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "target_branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
            echo "should_create_pr=false" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "schedule" ] || [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "target_branch=i18n" >> $GITHUB_OUTPUT
            echo "should_create_pr=true" >> $GITHUB_OUTPUT
          else
            echo "target_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "should_create_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup target branch
        run: |
          TARGET_BRANCH="${{ steps.determine_branch.outputs.target_branch }}"
          git fetch origin $TARGET_BRANCH || true
          git checkout -B $TARGET_BRANCH origin/$TARGET_BRANCH || git checkout -b $TARGET_BRANCH

      - name: Configure git
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@twenty.com'

      - name: Stash any changes before pulling translations
        run: |
          git add .
          git stash || true

      - name: Pull translated docs from Crowdin
        if: github.event_name == 'schedule' || github.event_name == 'pull_request' || inputs.force_pull == true || (github.event_name == 'workflow_dispatch' && inputs.force_pull != false)
        uses: crowdin/github-action@v2
        with:
          upload_sources: false
          upload_translations: false
          download_translations: true
          download_language: fr
          source: 'packages/twenty-docs/**/*.mdx'
          export_only_approved: false
          localization_branch_name: ${{ steps.determine_branch.outputs.target_branch }}
          base_url: 'https://twenty.api.crowdin.com'
          skip_untranslated_files: true
          push_translations: false
          create_pull_request: false
          skip_ref_checkout: true
          dryrun_action: false
        env:
          GITHUB_TOKEN: ${{ github.token }}
          CROWDIN_PROJECT_ID: '1'
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}

      - name: Fix file permissions
        run: sudo chown -R runner:docker . || true

      - name: Check for changes and commit
        id: check_changes
        run: |
          git add .
          if ! git diff --staged --quiet --exit-code; then
            git commit -m "chore: update docs translations from Crowdin"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: git push origin HEAD:${{ steps.determine_branch.outputs.target_branch }}

      - name: Create pull request
        if: steps.check_changes.outputs.changes_detected == 'true' && steps.determine_branch.outputs.should_create_pr == 'true'
        run: |
          if git diff --name-only origin/main..HEAD | grep -q .; then
            gh pr create -B main -H ${{ steps.determine_branch.outputs.target_branch }} --title 'i18n - docs translations' --body 'Created by Github action' || true
          else
            echo "No file differences between branches, skipping PR creation"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

