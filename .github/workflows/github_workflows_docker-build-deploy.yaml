name: Build and Push Docker Images

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      image-name: ${{ steps.image-info.outputs.image-name }}
      image-tag: ${{ steps.image-info.outputs.image-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Convert repository name to lowercase
        id: repo-name
        run: |
          echo "lowercase=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ steps.repo-name.outputs.lowercase }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push main application image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./packages/twenty-docker/twenty/Dockerfile
          # platforms: linux/amd64,linux/arm64  # Temporarily disabled for faster build
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            REACT_APP_SERVER_BASE_URL=${{ secrets.SERVER_URL }}
            APP_VERSION=0.0.0-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set image outputs for next jobs
        id: image-info
        run: |
          echo "image-name=ghcr.io/${{ steps.repo-name.outputs.lowercase }}" >> $GITHUB_OUTPUT
          echo "image-tag=latest" >> $GITHUB_OUTPUT

      - name: Build complete
        run: |
          echo "âœ… Image built and pushed successfully"
          echo "ğŸ“¦ Image: ${{ steps.image-info.outputs.image-name }}:${{ steps.image-info.outputs.image-tag }}"
          echo "ğŸ·ï¸  Tags:"
          echo "${{ steps.meta.outputs.tags }}"

  run-migrations:
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      # Guard for LSPs that dislike secrets in if:
      HAS_SEVALLA_WEBHOOK: ${{ secrets.SEVALLA_DEPLOY_WEBHOOK != '' }}

    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Wait for image to be available
        run: |
          echo "â³ Waiting for image to be fully available in registry..."
          sleep 10

      - name: Pull latest image
        run: |
          echo "ğŸ“¥ Pulling image: ${{ needs.build-and-push.outputs.image-name }}:${{ needs.build-and-push.outputs.image-tag }}"
          docker pull ${{ needs.build-and-push.outputs.image-name }}:${{ needs.build-and-push.outputs.image-tag }}

      - name: Validate secrets are configured
        run: |
          MISSING=""
          [ -z "${{ secrets.PG_DATABASE_URL }}" ] && echo "âŒ Missing: PG_DATABASE_URL" && MISSING="1"
          [ -z "${{ secrets.REDIS_URL }}" ] && echo "âŒ Missing: REDIS_URL" && MISSING="1"
          [ -z "${{ secrets.APP_SECRET }}" ] && echo "âŒ Missing: APP_SECRET" && MISSING="1"
          if [ -n "$MISSING" ]; then
            echo ""
            echo "âš ï¸  Migration job requires these secrets in: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Run database migrations
        run: |
          echo "ğŸ”„ Running database migrations..."
          docker run --rm \
            -e PG_DATABASE_URL="${{ secrets.PG_DATABASE_URL }}" \
            -e REDIS_URL="${{ secrets.REDIS_URL }}" \
            -e APP_SECRET="${{ secrets.APP_SECRET }}" \
            -e APP_VERSION="0.0.0-${{ github.sha }}" \
            -e DISABLE_CRON_JOBS_REGISTRATION=true \
            ${{ needs.build-and-push.outputs.image-name }}:${{ needs.build-and-push.outputs.image-tag }} \
            sh -c "yarn database:migrate:prod && yarn command:prod upgrade"

      - name: Verify migration success (best-effort)
        run: |
          docker run --rm \
            -e PG_DATABASE_URL="${{ secrets.PG_DATABASE_URL }}" \
            ${{ needs.build-and-push.outputs.image-name }}:${{ needs.build-and-push.outputs.image-tag }} \
            sh -c 'psql "$PG_DATABASE_URL" -c "SELECT COUNT(*) as migration_count FROM core.typeorm_metadata;"' || echo "â„¹ï¸ Skipping verification (psql may be unavailable)"

  deploy-to-sevalla:
    needs: [build-and-push, run-migrations]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      HAS_SEVALLA_WEBHOOK: ${{ secrets.SEVALLA_DEPLOY_WEBHOOK != '' }}

    steps:
      - name: Deployment ready
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… BUILD COMPLETE"
          echo "âœ… MIGRATIONS COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸš€ Ready to deploy in Sevalla"
          echo ""
          echo "ğŸ“¦ Image: ${{ needs.build-and-push.outputs.image-name }}:${{ needs.build-and-push.outputs.image-tag }}"
          echo "ğŸ”— Commit: ${{ github.sha }}   Branch: ${{ github.ref_name }}"
          echo ""

      - name: Trigger Sevalla deployment (webhook)
        if: env.HAS_SEVALLA_WEBHOOK == 'true'
        run: |
          echo "ğŸ”” Triggering Sevalla deployment webhook..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.SEVALLA_DEPLOY_WEBHOOK }}" \
            -H "Authorization: Bearer ${{ secrets.SEVALLA_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "image": "${{ needs.build-and-push.outputs.image-name }}:${{ needs.build-and-push.outputs.image-tag }}",
              "commit": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "actor": "${{ github.actor }}",
              "run_id": "${{ github.run_id }}"
            }')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Webhook OK (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
          else
            echo "âš ï¸ Webhook failed (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            echo "Proceed to deploy manually in Sevalla."
          fi

      - name: Manual deployment instructions
        if: env.HAS_SEVALLA_WEBHOOK != 'true'
        run: |
          echo "â„¹ï¸ No deployment webhook configured."
          echo "Deploy manually in Sevalla with image:"
          echo "  ${{ needs.build-and-push.outputs.image-name }}:${{ needs.build-and-push.outputs.image-tag }}"
          echo ""
          echo "To enable automatic deployment, add repository secrets:"
          echo "  - SEVALLA_DEPLOY_WEBHOOK"
          echo "  - SEVALLA_API_TOKEN"
