# **T√†i li·ªáu Quy tr√¨nh Ki·ªÉm tra Ph√¢n quy·ªÅn RBAC (Version 2.0)**

## **T·ªïng quan**

T√†i li·ªáu n√†y m√¥ t·∫£ quy tr√¨nh ki·ªÉm tra ph√¢n quy·ªÅn d·ª±a tr√™n vai tr√≤ (RBAC) ƒë∆∞·ª£c tri·ªÉn khai trong h·ªá th·ªëng marketing. H·ªá th·ªëng RBAC s·ª≠ d·ª•ng ph∆∞∆°ng ph√°p **6-layer validation** k·∫øt h·ª£p static permissions, dynamic policies, v√† temporal overrides ƒë·ªÉ ƒë·∫£m b·∫£o b·∫£o m·∫≠t to√†n di·ªán.

## **C√°c Th√†nh ph·∫ßn C·ªët l√µi**

### **Th√†nh ph·∫ßn RBAC Ch√≠nh (Coarse-grained)**
- **MktOrganizationLevelWorkspaceEntity**: ƒê·ªãnh nghƒ©a c√°c c·∫•p ƒë·ªô ph√¢n c·∫•p t·ªï ch·ª©c v√† quy·ªÅn c∆° b·∫£n
- **MktDepartmentWorkspaceEntity**: ƒê·∫°i di·ªán cho c√°c ph√≤ng ban ch·ª©c nƒÉng v·ªõi ch√≠nh s√°ch truy c·∫≠p c·ª• th·ªÉ
- **MktDepartmentHierarchyWorkspaceEntity**: Qu·∫£n l√Ω m·ªëi quan h·ªá cha-con gi·ªØa c√°c ph√≤ng ban
- **WorkspaceMemberMktEntity**: Li√™n k·∫øt ng∆∞·ªùi d√πng v·ªõi b·ªëi c·∫£nh t·ªï ch·ª©c c·ªßa h·ªç

### **Th√†nh ph·∫ßn Fine-grained Access Control**
- **MktDataAccessPolicyWorkspaceEntity**: Ch√≠nh s√°ch l·ªçc d·ªØ li·ªáu c·ª• th·ªÉ (Row-Level Security)
- **MktTemporaryPermissionWorkspaceEntity**: Quy·ªÅn t·∫°m th·ªùi c√≥ th·ªùi h·∫°n (Override permissions)
- **MktPermissionAuditWorkspaceEntity**: Nh·∫≠t k√Ω ki·ªÉm to√°n cho vi·ªác ki·ªÉm tra quy·ªÅn

### **Th√†nh ph·∫ßn Configuration & Constants**
- **RBAC_RESOURCES**: ƒê·ªãnh nghƒ©a t·∫•t c·∫£ t√†i nguy√™n h·ªá th·ªëng
- **RBAC_ACTIONS**: C√°c h√†nh ƒë·ªông c∆° b·∫£n (CRUD, Export, Approve, etc.)
- **RBAC_SYSTEM_ACTIONS**: C√°c kh·∫£ nƒÉng c·∫•p h·ªá th·ªëng
- **PERMISSION_TEMPLATES**: Template quy·ªÅn theo t·ª´ng organization level
- **ACCESS_LIMITATIONS**: Gi·ªõi h·∫°n v√† ƒëi·ªÅu ki·ªán truy c·∫≠p

## **Quy tr√¨nh Ki·ªÉm tra Ph√¢n quy·ªÅn (6 Layers)**

### **Layer 1: X√°c th·ª±c & Ph√¢n gi·∫£i B·ªëi c·∫£nh Ng∆∞·ªùi d√πng**
H·ªá th·ªëng ƒë·∫ßu ti√™n thi·∫øt l·∫≠p b·ªëi c·∫£nh t·ªï ch·ª©c c·ªßa ng∆∞·ªùi d√πng:
```typescript
interface UserContext {
  userId: string;
  departmentId: string;
  organizationLevelId: string;
  employmentStatusId: string;
  region: string;
  directReports: string[];
}
```

### **Layer 2: Ki·ªÉm tra C·∫•p ƒë·ªô T·ªï ch·ª©c**
**M·ª•c ƒë√≠ch**: Thi·∫øt l·∫≠p khung quy·ªÅn c∆° b·∫£n t·ª´ PERMISSION_TEMPLATES

**C·∫•u tr√∫c permissions**:
```typescript
defaultPermissions: {
  resources: {
    [RBAC_RESOURCES.CUSTOMERS]: [RBAC_ACTIONS.READ, RBAC_ACTIONS.CREATE],
    [RBAC_RESOURCES.ORDERS]: [RBAC_ACTIONS.READ, RBAC_ACTIONS.UPDATE],
    // ...
  },
  actions: {
    [RBAC_SYSTEM_ACTIONS.DATA_EXPORT]: false,
    [RBAC_SYSTEM_ACTIONS.ADMIN_FUNCTIONS]: false,
    // ...
  },
  restrictions: {
    [RBAC_RESTRICTIONS.MAX_RECORDS_PER_QUERY]: 1000,
    [RBAC_RESTRICTIONS.WORKING_HOURS_ONLY]: true,
    // ...
  }
}
```

**ƒêi·ªÉm quy·∫øt ƒë·ªãnh**: N·∫øu action kh√¥ng c√≥ trong resources ho·∫∑c actions = false ‚Üí DENY

### **Layer 3: ƒê√°nh gi√° Truy c·∫≠p Ph√≤ng ban & Ph√¢n c·∫•p**
**M·ª•c ƒë√≠ch**: X√°c th·ª±c quy·ªÅn ph√≤ng ban v√† √°p d·ª•ng hierarchy rules

**C√°c ki·ªÉm tra ch√≠nh**:
- Tr·∫°ng th√°i ho·∫°t ƒë·ªông c·ªßa ph√≤ng ban
- Quy·ªÅn truy c·∫≠p li√™n ph√≤ng ban (`allowsCrossDepartmentAccess`)
- Manager privileges trong hierarchy:
  - `canViewTeamData`: Xem d·ªØ li·ªáu team con
  - `canEditTeamData`: S·ª≠a d·ªØ li·ªáu team con
  - `canExportTeamData`: Xu·∫•t d·ªØ li·ªáu team con

### **Layer 4: √Åp d·ª•ng Access Limitations**
**M·ª•c ƒë√≠ch**: √Åp d·ª•ng c√°c r√†ng bu·ªôc t·ª´ accessLimitations

**C√°c ki·ªÉm tra**:
```typescript
accessLimitations: {
  temporal: {
    working_hours: { enabled: true, start: "08:00", end: "18:00" },
    session_timeout: 3600
  },
  functional: {
    blocked_actions: ["delete_any_record", "admin_functions"],
    require_approval: ["large_data_export"],
    escalation_required: ["financial_data"]
  }
}
```

**ƒêi·ªÉm quy·∫øt ƒë·ªãnh**:
- `blocked_actions` ‚Üí **DENY tuy·ªát ƒë·ªëi**
- `temporal violations` ‚Üí **DENY**
- `require_approval` ‚Üí **CONDITIONAL**
- `escalation_required` ‚Üí **ESCALATION**

### **Layer 5: √Åp d·ª•ng Data Access Policies (Row-Level Security)**
**M·ª•c ƒë√≠ch**: L·ªçc d·ªØ li·ªáu theo business rules c·ª• th·ªÉ

**C·∫•u tr√∫c policy**:
```typescript
{
  name: "Regional Sales Access",
  department: "Sales",
  objectName: "mktCustomer",
  filterConditions: {
    "region": "${user.region}",
    "assignedTo": "${current_user_id}",
    "status": {"$ne": "inactive"}
  },
  priority: 100
}
```

**X·ª≠ l√Ω**:
- Multiple policies ‚Üí Merge by priority (higher number = higher precedence)
- Dynamic variables: `${user.id}`, `${user.region}`, `${user.department}`
- Complex conditions: AND, OR, nested objects
- **K·∫øt qu·∫£**: FILTERED DATA (kh√¥ng ph·∫£i GRANT/DENY)

### **Layer 6: Ki·ªÉm tra Temporary Permissions (Override Layer)**
**M·ª•c ƒë√≠ch**: Override m·ªçi gi·ªõi h·∫°n tr√™n v·ªõi quy·ªÅn c√≥ th·ªùi h·∫°n

**C·∫•u tr√∫c temporary permission**:
```typescript
{
  granteeWorkspaceMember: "user_123",
  granterWorkspaceMember: "manager_456",
  objectName: "mktFinancialReport",
  recordId: "specific_report_id", // null = all records
  canRead: true,
  canUpdate: false,
  canDelete: false,
  expiresAt: "2024-12-31T23:59:59",
  reason: "Year-end audit compliance",
  purpose: "External auditor data access",
  isActive: true
}
```

**ƒêi·ªÉm quy·∫øt ƒë·ªãnh**: N·∫øu c√≥ temporary permission h·ª£p l·ªá ‚Üí **OVERRIDE** t·∫•t c·∫£ restrictions tr√™n

## **Lu·ªìng Quy·∫øt ƒë·ªãnh**

### **Th·ª© t·ª± Ph√¢n gi·∫£i Quy·ªÅn**
```
1. Organization Level (defaultPermissions/accessLimitations)
   ‚Üì GRANT/DENY
2. Department Access (basic department rules)
   ‚Üì GRANT/DENY
3. Department Hierarchy (inheritance & delegation)
   ‚Üì INHERIT/OVERRIDE
4. Access Limitations (temporal, functional blocks)
   ‚Üì DENY/CONDITIONAL/ESCALATION
5. Data Access Policies (Row-Level Security)
   ‚Üì FILTER/REFINE
6. Temporary Permissions (Override)
   ‚Üì OVERRIDE/GRANT
7. Final Result
```

### **Priority Matrix**

| Priority Level | Component | Override Capability |
|---------------|-----------|---------------------|
| **1 (Highest)** | Temporary Permissions | Can override ALL restrictions |
| **2** | accessLimitations.blocked_actions | Cannot be overridden by org level |
| **3** | accessLimitations.temporal | Can be overridden by temporary |
| **4** | Data Access Policies | Filter data, don't deny access |
| **5** | Department Hierarchy Rules | Apply inheritance and delegation |
| **6 (Lowest)** | defaultPermissions | Base permissions framework |

### **Decision Matrix**

| Organization Level | Data Policy | Temporary Permission | Final Result |
|-------------------|-------------|---------------------|--------------|
| DENY | Any | None | ‚ùå DENY |
| DENY | Any | ACTIVE GRANT | ‚úÖ TEMPORARY GRANT |
| GRANT | FILTER | None | ‚úÖ FILTERED GRANT |
| GRANT | FILTER | ACTIVE GRANT | ‚úÖ TEMPORARY (Bypass Filter) |
| GRANT | blocked_actions | None | ‚ùå DENY |
| GRANT | blocked_actions | ACTIVE GRANT | ‚úÖ TEMPORARY OVERRIDE |
| GRANT | temporal violation | None | ‚ùå DENY |
| GRANT | temporal violation | ACTIVE GRANT | ‚úÖ TEMPORARY OVERRIDE |
| GRANT | require_approval | None | ‚ö†Ô∏è CONDITIONAL |
| GRANT | escalation_required | None | üîÑ ESCALATION |
| GRANT | No restrictions | None | ‚úÖ FULL GRANT |

## **V√≠ d·ª• Th·ª±c t·∫ø**

### **Tr∆∞·ªùng h·ª£p 1: Standard Department Access**
```
User: Sales Staff (Level: SENIOR_STAFF, Department: Sales)
Request: Read customers assigned to them
Time: 14:00 (Tuesday)

Flow:
1. Organization Level: ‚úÖ SENIOR_STAFF.defaultPermissions.resources.customers = ['read', 'create']
2. Department: ‚úÖ Sales department active
3. Hierarchy: ‚úÖ No cross-department access needed
4. Access Limitations: ‚úÖ Within working hours
5. Data Policy: Applied "Own Records Only"
   filterConditions: {"assignedTo": "${current_user_id}"}
6. Temporary: None

Result: ‚úÖ GRANTED with DATA FILTERING
‚Üí User ch·ªâ th·∫•y customers ƒë∆∞·ª£c assign cho m√¨nh
```

### **Tr∆∞·ªùng h·ª£p 2: Cross-Department Denial**
```
User: Sales Staff (Level: SENIOR_STAFF)
Request: Read HR employee records
Time: 10:00 (Monday)

Flow:
1. Organization Level: ‚úÖ SENIOR_STAFF c√≥ basic read permissions
2. Department: ‚ùå Sales department, allowsCrossDepartmentAccess = false
3. Access Limitations: HR in restricted_departments = ['hr', 'finance', 'executive']
4. ‚Üí MULTIPLE LAYER DENIAL

Result: ‚ùå DENIED
‚Üí Multiple layers block HR data access
```

### **Tr∆∞·ªùng h·ª£p 3: Manager Hierarchy Access**
```
User: Sales Manager (Level: MANAGER)
Request: Update performance data c·ªßa Sales Staff
Time: 16:00 (Wednesday)

Flow:
1. Organization Level: ‚úÖ MANAGER.defaultPermissions supports update
2. Department: ‚úÖ Same department (Sales)
3. Hierarchy: ‚úÖ Manager ‚Üí Staff relationship
   - canEditTeamData = true
   - inheritsPermissions = false (Manager c√≥ quy·ªÅn ri√™ng)
4. Access Limitations: ‚úÖ No blocks
5. Data Policy: "Manager Team Access"
   filterConditions: {"department": "Sales", "reportingTo": "${user.id}"}

Result: ‚úÖ GRANTED with TEAM FILTERING
‚Üí Manager ch·ªâ edit ƒë∆∞·ª£c data c·ªßa direct reports
```

### **Tr∆∞·ªùng h·ª£p 4: Temporary Permission Emergency Access**
```
User: Marketing Staff (Level: SENIOR_STAFF)
Request: Read specific financial report for audit
Resource: mktFinancialReport
Record: "Q4_2024_Budget_Analysis"
Time: 20:00 (Friday) - Outside working hours

Flow:
1. Organization Level: ‚ùå SENIOR_STAFF kh√¥ng c√≥ financial_data access
2. Access Limitations: ‚ùå Outside working_hours (08:00-18:00)
3. Temporary Permission Found:
   {
     "grantee": "current_user",
     "granter": "finance_manager",
     "objectName": "mktFinancialReport",
     "recordId": "Q4_2024_Budget_Analysis",
     "canRead": true,
     "expiresAt": "2024-12-31T23:59:59",
     "reason": "External audit compliance requirement",
     "purpose": "Year-end financial audit support"
   }
   ‚Üí TEMPORARY OVERRIDE ‚úÖ

Result: ‚úÖ GRANTED (Temporary, Audited)
‚Üí Override both organization level v√† temporal restrictions
‚Üí Full audit trail: who, what, why, when, until when
```

### **Tr∆∞·ªùng h·ª£p 5: Complex Data Policy with Regional Restrictions**
```
User: Regional Manager (Level: MANAGER, Region: Central)
Request: Bulk export customer data
Resource: mktCustomer (all records)
Time: 11:00 (Thursday)

Flow:
1. Organization Level: ‚úÖ MANAGER.actions.data_export = true
2. Department: ‚úÖ Sales department
3. Hierarchy: ‚úÖ Manager level access
4. Access Limitations: ‚úÖ Within working hours, no blocks
5. Data Policy Stack (multiple policies applied):

   Policy 1: "Regional Access Control" (Priority: 100)
   filterConditions: {"region": "Central"}

   Policy 2: "Manager Customer Access" (Priority: 50)
   filterConditions: {"status": {"$in": ["active", "pending"]}}

   Policy 3: "Export Size Limit" (Priority: 75)
   filterConditions: {"createdAt": {"$gte": "2024-01-01"}}

   Combined Filter (by priority):
   {
     "region": "Central",
     "status": {"$in": ["active", "pending"]},
     "createdAt": {"$gte": "2024-01-01"}
   }

6. Restrictions Check:
   - max_export_size: 100,000 records
   - require_approval: ["large_data_export"]
   ‚Üí CONDITIONAL (if result > 100k records)

Result: ‚úÖ GRANTED with MULTI-LAYER FILTERING + SIZE LIMIT
‚Üí Export ch·ªâ customers: Central region + Active/Pending + Created 2024+
‚Üí N·∫øu > 100k records th√¨ c·∫ßn approval t·ª´ Director
```

## **RBAC Architecture Summary**

### **Static vs Dynamic Permissions**

| Lo·∫°i | Entity | M·ª•c ƒë√≠ch | ƒê·∫∑c ƒëi·ªÉm |
|------|--------|----------|----------|
| **Static** | MktOrganizationLevelWorkspaceEntity | Khung quy·ªÅn c∆° b·∫£n | √çt thay ƒë·ªïi, theo c·∫•p b·∫≠c |
| **Static** | MktDepartmentWorkspaceEntity | Nh√≥m ch·ª©c nƒÉng | Theo ph√≤ng ban, business rules |
| **Dynamic** | MktDataAccessPolicyWorkspaceEntity | Row-level filtering | Linh ho·∫°t, theo d·ªØ li·ªáu |
| **Dynamic** | MktTemporaryPermissionWorkspaceEntity | Exception handling | T·∫°m th·ªùi, c√≥ th·ªùi h·∫°n |

### **Data Storage Evolution**

**Tr∆∞·ªõc ƒë√¢y (TEXT-based)**:
```typescript
// L∆∞u tr·ªØ
defaultPermissions: string // JSON.stringify()
accessLimitations: string  // JSON.stringify()

// S·ª≠ d·ª•ng
const perms = JSON.parse(user.organizationLevel.defaultPermissions);
```

**Hi·ªán t·∫°i (Native JSON)**:
```typescript
// L∆∞u tr·ªØ
defaultPermissions: DefaultPermissions  // Native JSON
accessLimitations: AccessLimitations   // Native JSON

// S·ª≠ d·ª•ng (no parsing needed)
const perms = user.organizationLevel.defaultPermissions;
if (perms.actions[RBAC_SYSTEM_ACTIONS.DATA_EXPORT]) { /* ... */ }
```

### **Centralized Configuration**

**RBAC Constants Structure**:
```typescript
// Resource definitions
RBAC_RESOURCES: { CUSTOMERS: 'customers', ORDERS: 'orders', ... }

// Action definitions
RBAC_ACTIONS: { READ: 'read', CREATE: 'create', ... }

// System capabilities
RBAC_SYSTEM_ACTIONS: { DATA_EXPORT: 'data_export', ... }

// Pre-built templates
PERMISSION_TEMPLATES: {
  DIRECTOR: { defaultPermissions: {...}, accessLimitations: {...} },
  MANAGER: { defaultPermissions: {...}, accessLimitations: {...} },
  // ...
}
```

## **Implementation Guidelines**

### **Security Best Practices**
- **Fail-Safe Default**: M·∫∑c ƒë·ªãnh DENY n·∫øu kh√¥ng c√≥ quy·ªÅn r√µ r√†ng
- **Audit Logging**: Log t·∫•t c·∫£ permission decisions v√† temporary grants
- **Input Validation**: Validate t·∫•t c·∫£ filterConditions v√† permission scopes
- **SQL Injection Prevention**: S·ª≠ d·ª•ng parameterized queries cho data policies

### **Performance Optimization**
- **Strategic Caching**: Cache permission results, data policies, v√† user contexts
- **Database Optimization**: Index department, organization level, v√† policy lookups
- **Efficient Queries**: Batch permission checks v√† optimize data policy queries
- **Native JSON**: S·ª≠ d·ª•ng RAW_JSON thay v√¨ TEXT ƒë·ªÉ tr√°nh parsing overhead

### **Monitoring & Alerting**
- **Permission Failures**: Alert khi c√≥ qu√° nhi·ªÅu DENY
- **Temporary Permission Usage**: Monitor vi·ªác s·ª≠ d·ª•ng temporary permissions
- **Policy Conflicts**: Detect v√† alert policy conflicts
- **Performance Metrics**: Track permission check latency

### **Testing Strategy**
- **Unit Tests**: Test t·ª´ng layer permission ri√™ng bi·ªát
- **Integration Tests**: Test full permission flow
- **Security Tests**: Test bypass attempts v√† edge cases
- **Load Tests**: Test performance v·ªõi large datasets

## **Migration & Deployment**

### **Database Migration Strategy**
1. **Schema Updates**: Migrate defaultPermissions v√† accessLimitations from TEXT to RAW_JSON
2. **Data Conversion**: Convert existing JSON strings to native JSON objects
3. **Template Application**: Update existing records to use PERMISSION_TEMPLATES
4. **Index Creation**: Add indexes for performance optimization

### **Rollback Plan**
- Keep backup of original TEXT-based data
- Maintain conversion scripts for rollback if needed
- Gradual rollout v·ªõi feature flags

### **Testing Checklist**
- [ ] Unit tests cho t·∫•t c·∫£ permission layers
- [ ] Integration tests cho complex scenarios
- [ ] Performance tests v·ªõi large datasets
- [ ] Security penetration testing
- [ ] Load testing cho concurrent users
- [ ] Audit trail validation

## **System Guarantees**

üîí **Security Guarantees**:
- **Fail-Safe**: Default DENY if any component fails
- **No Privilege Escalation**: Temporary permissions cannot exceed organizational boundaries for critical actions
- **Audit Completeness**: Every permission decision is logged with full context
- **Time Bounds**: All temporary access automatically expires

‚ö° **Performance Guarantees**:
- **Sub-second Response**: Permission checks complete within 500ms for 99% of requests
- **Efficient Caching**: Cache hit rate > 90% for repeated permission checks
- **Graceful Degradation**: System remains functional even if policy services are degraded

üéØ **Functional Guarantees**:
- **Consistency**: Same user, same context, same resource = same permission result
- **Precedence**: Clear precedence order prevents ambiguous permission states
- **Granularity**: Support from organization-wide down to individual record permissions

---

**‚ö†Ô∏è L∆∞u √Ω Quan tr·ªçng**: ƒê√¢y l√† h·ªá th·ªëng RBAC multi-layer ph·ª©c t·∫°p. Vi·ªác tri·ªÉn khai y√™u c·∫ßu:
- **Extensive Testing**: Test k·ªπ l∆∞·ª°ng t·∫•t c·∫£ scenarios
- **Gradual Rollout**: Deploy t·ª´ng layer m·ªôt ƒë·ªÉ identify issues s·ªõm
- **Monitoring**: Set up comprehensive monitoring v√† alerting
- **Documentation**: Maintain up-to-date permission documentation
- **Training**: Train developers v·ªÅ RBAC flow v√† troubleshooting

**üîê Security First**: Always err on the side of denial. Better to have false negatives than false positives trong access control.