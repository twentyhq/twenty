suite: secret generation
templates:
  - templates/secret-tokens.yaml
  - templates/secret-db-user.yaml
  - templates/secret-db-superuser.yaml
  - templates/secret-db-url.yaml
release:
  name: my-twenty
  namespace: default
tests:
  - it: generates tokens
    template: templates/secret-tokens.yaml
    set:
      secrets.tokens.create: true
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: tokens

  - it: db-user secret generates random password when not provided
    template: templates/secret-db-user.yaml
    set:
      db.enabled: true
      db.createUserHook.enabled: true
    asserts:
      - isKind:
          of: Secret
      - matchRegex:
          path: stringData.password
          pattern: "^[a-zA-Z0-9]{24}$"

  - it: db-user secret uses provided password
    template: templates/secret-db-user.yaml
    set:
      db.enabled: true
      db.createUserHook.enabled: true
      db.createUserHook.password: "my-secure-password"
    asserts:
      - equal:
          path: stringData.password
          value: "my-secure-password"

  - it: db-superuser secret generates password for internal DB
    template: templates/secret-db-superuser.yaml
    set:
      db.enabled: true
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: my-twenty-twenty-db-superuser

  - it: db-superuser secret does not render when internal DB disabled
    template: templates/secret-db-superuser.yaml
    set:
      db.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: db-url secret renders for internal database
    template: templates/secret-db-url.yaml
    set:
      db.enabled: true
      db.name: appdb
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: my-twenty-twenty-db-url
