suite: secret generation
templates:
  - templates/secret-tokens.yaml
  - templates/secret-db-superuser.yaml
  - templates/secret-db-url.yaml
release:
  name: my-twenty
  namespace: default
tests:
  - it: generates tokens
    template: templates/secret-tokens.yaml
    set:
      secrets.tokens.create: true
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: tokens

  # db-user secret removed; chart no longer manages app user credentials

  - it: db-superuser secret generates password for internal DB
    template: templates/secret-db-superuser.yaml
    set:
      db.enabled: true
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: my-twenty-twenty-db-superuser

  - it: db-superuser secret does not render when internal DB disabled
    template: templates/secret-db-superuser.yaml
    set:
      db.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: db-url secret renders for internal database
    template: templates/secret-db-url.yaml
    set:
      db.enabled: true
      db.internal.database: appdb
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: my-twenty-twenty-db-url
