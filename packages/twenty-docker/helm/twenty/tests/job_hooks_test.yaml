suite: job hooks
templates:
  - templates/job-create-database.yaml
  - templates/job-create-db-user.yaml
  - templates/job-run-migrations.yaml
release:
  name: my-twenty
  namespace: default
tests:
  - it: create-database job uses secretKeyRef for password
    template: templates/job-create-database.yaml
    set:
      db.enabled: true
      db.createDatabaseHook.enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="PGPASSWORD")].valueFrom.secretKeyRef.name
          value: my-twenty-twenty-db-superuser
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="PGPASSWORD")].valueFrom.secretKeyRef.key
          value: password

  - it: create-database job has correct hook annotations
    template: templates/job-create-database.yaml
    set:
      db.enabled: true
      db.createDatabaseHook.enabled: true
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: post-install,post-upgrade
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: before-hook-creation,hook-succeeded

  - it: migrations job has correct hook weight
    template: templates/job-run-migrations.yaml
    set:
      db.enabled: true
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook-weight"]
          value: "5"

  - it: migrations job uses db-url secret
    template: templates/job-run-migrations.yaml
    set:
      db.enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="PG_DATABASE_URL")].valueFrom.secretKeyRef.name
          value: my-twenty-twenty-db-url
      - equal:
          path: spec.template.spec.containers[0].env[?(@.name=="PG_DATABASE_URL")].valueFrom.secretKeyRef.key
          value: url

  - it: create-database job renders when enabled
    template: templates/job-create-database.yaml
    set:
      db.enabled: true
      db.createDatabaseHook.enabled: true
    asserts:
      - hasDocuments:
          count: 1

  - it: migrations job renders with any database configuration
    template: templates/job-run-migrations.yaml
    asserts:
      - hasDocuments:
          count: 1
